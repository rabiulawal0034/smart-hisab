<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-pink: #e91e63;
            --header-cyan: #80ced6;
            --income-green: #0e8a16;
            --expense-red: #c90a4d;
            --balance-teal: #008080;
            --bg-light: #f3f4f6;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: var(--bg-light);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .app-container {
            width: 100vw;
            max-width: 450px;
            background-color: var(--bg-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            position: relative;
        }

        /* PIN Screen */
        #pin-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--balance-teal);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        #pin-input {
            width: 150px;
            padding: 12px;
            text-align: center;
            font-size: 28px;
            border: none;
            border-radius: 12px;
            margin-bottom: 20px;
            outline: none;
        }

        .pin-btn {
            width: 150px;
            background: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-weight: bold;
            color: var(--balance-teal);
            cursor: pointer;
            transition: 0.2s;
        }

        .pin-btn:hover {
            transform: scale(1.05);
        }

        /* Header */
        .header {
            background-color: var(--header-cyan);
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            position: relative;
        }

        .menu-icon {
            position: absolute;
            right: 15px;
            top: 12px;
            font-size: 28px;
            cursor: pointer;
            color: #333;
            transition: 0.2s;
        }

        .menu-icon:hover {
            transform: scale(1.1);
        }

        /* Side Menu */
        .side-menu {
            position: fixed;
            top: 0;
            right: -280px;
            width: 250px;
            height: 100%;
            background: white;
            z-index: 2000;
            transition: 0.4s;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
            overflow-y: auto;
        }

        .side-menu.active { right: 0; }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
            display: none;
        }

        .menu-overlay.active {
            display: block;
        }

        .menu-item {
            background: #f1f3f5;
            padding: 14px;
            border-radius: 12px;
            font-size: 14px;
            text-align: center;
            cursor: pointer;
            border: 1px solid #dee2e6;
            font-weight: 600;
            color: #333;
            display: block;
            text-decoration: none;
            transition: 0.2s;
        }

        .menu-item:hover {
            background: #e9ecef;
            transform: translateX(-5px);
        }

        /* Entry Panel (NEW) */
        .entry-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2500;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .entry-panel.active { display: flex; }
        .entry-panel-content {
            background: white;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            border-radius: 20px;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }
        .close-panel {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            transition: 0.2s;
        }

        .close-panel:hover {
            color: #000;
            transform: scale(1.2);
        }

        .entry-tabs {
            display: flex;
            margin: 20px 0 20px;
            gap: 5px;
        }
        .entry-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: #eee;
            cursor: pointer;
            font-weight: bold;
            border-radius: 8px;
            transition: 0.2s;
            font-size: 16px;
        }
        .entry-tab.active {
            background: var(--primary-pink);
            color: white;
        }

        .entry-form {
            display: none;
        }
        .entry-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-pink);
        }

        .submit-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary-pink);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 10px;
        }
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(233, 30, 99, 0.4);
        }

        /* Category Management Panel */
        .category-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2500;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .category-panel.active { display: flex; }
        .category-panel-content {
            background: white;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            border-radius: 20px;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .cat-tabs {
            display: flex;
            margin: 20px 0 10px;
            gap: 5px;
        }
        .cat-tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: #eee;
            cursor: pointer;
            font-weight: bold;
            border-radius: 8px;
            transition: 0.2s;
        }
        .cat-tab.active {
            background: var(--primary-pink);
            color: white;
        }
        .cat-list {
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 5px;
        }
        .cat-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .cat-item:last-child {
            border-bottom: none;
        }

        .cat-item-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        .cat-color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .cat-actions button {
            padding: 5px 10px;
            margin-left: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: 0.2s;
        }
        .cat-edit-btn {
            background: #4CAF50;
            color: white;
        }
        .cat-delete-btn {
            background: #f44336;
            color: white;
        }
        .cat-actions button:hover {
            transform: scale(1.05);
        }

        .cat-add-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #eee;
        }
        .cat-add-inputs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .cat-add-inputs input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        .cat-add-inputs input[type="color"] {
            width: 50px;
            padding: 5px;
            cursor: pointer;
        }
        .cat-add-btn {
            width: 100%;
            padding: 10px;
            background: var(--primary-pink);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .cat-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(233,30,99,0.3);
        }

        /* FIXED TOP SECTION */
        .fixed-top-section {
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: var(--bg-light);
        }

        /* Summary Cards */
        .summary {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .card {
            background-color: white;
            padding: 15px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-bottom: 4px solid;
        }

        .card:nth-child(1) { 
            border-bottom-color: var(--income-green); 
        }

        .card:nth-child(2) { 
            border-bottom-color: var(--expense-red); 
        }

        .card:nth-child(3) { 
            border-bottom-color: var(--balance-teal); 
        }

        .card-title {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .card-amount {
            font-size: 18px;
            font-weight: bold;
        }

        .income { color: var(--income-green); }
        .expense { color: var(--expense-red); }
        .balance { color: var(--balance-teal); }

        /* View Selection Container */
        .view-selection {
            background: white;
            margin: 0 15px 10px;
            padding: 12px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .view-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .view-btn {
            padding: 10px;
            background-color: #eee;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: 0.2s;
        }

        .view-btn.active {
            background-color: var(--primary-pink);
            color: white;
        }

        .view-btn:hover {
            transform: translateY(-2px);
        }

        .filter-controls {
            padding: 10px 0;
        }

        .filter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }

        .filter-controls select,
        .filter-controls input[type="date"] {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
        }

        /* Chart Section */
        .chart-section {
            background: white;
            margin: 10px 15px;
            padding: 15px;
            border-radius: 20px;
            border-bottom: 4px solid var(--header-cyan);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-header {
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
        }

        .chart-content {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .chart-container {
            position: relative;
            width: 160px;
            height: 160px;
            flex-shrink: 0;
        }

        .category-list {
            flex: 1;
            max-height: 160px;
            overflow-y: auto;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #eee;
        }

        .category-item:last-child {
            border-bottom: none;
        }

        .category-name {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .color-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .category-amount {
            font-weight: bold;
            color: #333;
            font-size: 13px;
        }

        /* Transaction List */
        .list-section {
            flex: 1;
            overflow-y: auto;
            padding: 0 15px 100px;
        }

        .item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid;
            flex-wrap: wrap;
        }

        .cat-badge {
            display: inline-block;
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
            color: #666;
        }

        .delete-btn {
            background: #ff5252;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
            transition: 0.2s;
        }

        .delete-btn:hover {
            background: #ff1744;
            transform: scale(1.05);
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-size: 16px;
        }

        .date-filter-error {
            text-align: center;
            color: var(--expense-red);
            padding: 20px;
            font-weight: bold;
        }

        /* Add Button - ‡¶è‡¶ñ‡¶æ‡¶®‡ßá‡¶á ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá */
        .add-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-pink);
            color: white;
            font-size: 32px;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(233,30,99,0.4);
            transition: 0.3s;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(233,30,99,0.6);
        }

        /* Responsive */
        @media (max-width: 400px) {
            .view-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>

<!-- PIN Screen -->
<div id="pin-screen">
    <h2 style="margin-bottom:30px">üîê ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</h2>
    <input type="password" id="pin-input" maxlength="4" placeholder="PIN">
    <button class="pin-btn" onclick="verifyPin()">‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</button>
</div>

<div class="app-container">
    <!-- Header -->
    <div class="header">
        ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨
        <span class="menu-icon" onclick="toggleMenu()">‚ò∞</span>
    </div>

    <!-- FIXED TOP SECTION -->
    <div class="fixed-top-section">
        <!-- Summary Cards -->
        <div class="summary">
            <div class="card">
                <div class="card-title" id="card-income-title">‡¶Ü‡¶Ø‡¶º</div>
                <div class="card-amount income" id="total-income">‡ß≥‡ß¶</div>
            </div>
            <div class="card">
                <div class="card-title" id="card-expense-title">‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º</div>
                <div class="card-amount expense" id="total-expense">‡ß≥‡ß¶</div>
            </div>
            <div class="card">
                <div class="card-title" id="card-balance-title">‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</div>
                <div class="card-amount balance" id="balance">‡ß≥‡ß¶</div>
            </div>
        </div>

        <!-- View Selection -->
        <div class="view-selection">
            <div class="view-buttons">
                <button class="view-btn active" onclick="setView(event, 'today')">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞</button>
                <button class="view-btn" onclick="setView(event, 'monthly')">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï</button>
                <button class="view-btn" onclick="setView(event, 'yearly')">‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï</button>
                <button class="view-btn" onclick="setView(event, 'custom')">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ</button>
            </div>

            <div class="filter-controls">
                <div class="filter-row" id="monthly-filter" style="display:none">
                    <select id="filter-month"></select>
                    <select id="filter-year"></select>
                </div>
                <div class="filter-row" id="yearly-filter" style="display:none">
                    <select id="filter-year-only"></select>
                </div>
                <div id="custom-filter" style="display:none">
                    <div class="filter-row">
                        <input type="date" id="filter-start-date" placeholder="‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ">
                        <input type="date" id="filter-end-date" placeholder="‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <div class="chart-section">
        <div class="chart-header">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶ñ‡¶∞‡¶ö</div>
        <div class="chart-content">
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="category-list" id="categoryList"></div>
        </div>
    </div>

    <!-- Transaction List -->
    <div class="list-section" id="list"></div>

    <!-- Add Button - ‡¶è‡¶á ‡¶¨‡¶æ‡¶ü‡¶®‡¶ü‡¶ø ‡¶∏‡¶¨‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶®‡¶ø‡¶ö‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá -->
    <button class="add-btn" onclick="openEntryPanel()">+</button>
</div>

<!-- Entry Panel (NEW) -->
<div class="entry-panel" id="entryPanel">
    <div class="entry-panel-content">
        <span class="close-panel" onclick="closeEntryPanel()">√ó</span>
        <h2 style="text-align: center; margin-top: 0;">‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
        
        <div class="entry-tabs">
            <button class="entry-tab active" onclick="switchEntryTab(event, 'income')">‡¶Ü‡¶Ø‡¶º</button>
            <button class="entry-tab" onclick="switchEntryTab(event, 'expense')">‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º</button>
        </div>

        <!-- Income Form -->
        <div class="entry-form active" id="income-form">
            <div class="form-group">
                <label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</label>
                <input type="number" id="income-amount" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£">
            </div>
            <div class="form-group">
                <label>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</label>
                <input type="text" id="income-title" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
            </div>
            <div class="form-group">
                <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</label>
                <select id="income-category"></select>
            </div>
            <div class="form-group">
                <label>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                <input type="date" id="income-date">
            </div>
            <button class="submit-btn" onclick="submitEntry('income')">‡¶Ü‡¶Ø‡¶º ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>

        <!-- Expense Form -->
        <div class="entry-form" id="expense-form">
            <div class="form-group">
                <label>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡ß≥)</label>
                <input type="number" id="expense-amount" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£">
            </div>
            <div class="form-group">
                <label>‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</label>
                <input type="text" id="expense-title" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
            </div>
            <div class="form-group">
                <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</label>
                <select id="expense-category"></select>
            </div>
            <div class="form-group">
                <label>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                <input type="date" id="expense-date">
            </div>
            <button class="submit-btn" onclick="submitEntry('expense')">‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>
</div>

<!-- Category Management Panel -->
<div class="category-panel" id="categoryPanel">
    <div class="category-panel-content">
        <span class="close-panel" onclick="closeCategoryPanel()">√ó</span>
        <h2 style="text-align: center; margin-top: 0;">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h2>
        
        <div class="cat-tabs">
            <button class="cat-tab active" onclick="switchCatTab(event, 'income')">‡¶Ü‡¶Ø‡¶º</button>
            <button class="cat-tab" onclick="switchCatTab(event, 'expense')">‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º</button>
        </div>

        <div class="cat-list" id="catListIncome"></div>
        <div class="cat-list" id="catListExpense" style="display:none"></div>

        <div class="cat-add-section">
            <h4>‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</h4>
            <div class="cat-add-inputs">
                <input type="text" id="newCatName" placeholder="‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ">
                <input type="color" id="newCatColor" value="#e91e63">
            </div>
            <button class="cat-add-btn" onclick="addCategory()">‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>
</div>

<!-- Side Menu -->
<div class="menu-overlay" id="overlay" onclick="toggleMenu()"></div>
<div class="side-menu" id="sideMenu">
    <div class="menu-item" onclick="openCategoryPanel(); toggleMenu();">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</div>
    <div class="menu-item" onclick="createBackup(); toggleMenu();">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</div>
    <label class="menu-item" for="restore-file">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
        <input type="file" id="restore-file" accept=".json" onchange="restoreBackup(event); toggleMenu();" style="display:none">
    </label>
    <div class="menu-item" onclick="exportToExcel(); toggleMenu();">‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</div>
    <div class="menu-item" onclick="setNewPin(); toggleMenu();">PIN ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div>
</div>

<script>
    let history = [];
    let userPin = localStorage.getItem('app_pin') || '1234';
    let currentView = 'today';
    let currentCatType = 'income';
    let currentEntryType = 'income';
    let categoryChart = null;

    const defaultCategories = {
        income: [
            { name: '‡¶¨‡ßá‡¶§‡¶®', color: '#4CAF50' },
            { name: '‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ', color: '#2196F3' },
            { name: '‡¶¨‡ßã‡¶®‡¶æ‡¶∏', color: '#FF9800' },
            { name: '‡¶â‡¶™‡¶π‡¶æ‡¶∞', color: '#9C27B0' },
            { name: '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø', color: '#607D8B' }
        ],
        expense: [
            { name: '‡¶ñ‡¶æ‡¶¨‡¶æ‡¶∞', color: '#F44336' },
            { name: '‡¶Ø‡¶æ‡¶§‡¶æ‡¶Ø‡¶º‡¶æ‡¶§', color: '#FF5722' },
            { name: '‡¶¨‡¶ø‡¶≤', color: '#795548' },
            { name: '‡¶∂‡¶™‡¶ø‡¶Ç', color: '#E91E63' },
            { name: '‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ', color: '#009688' },
            { name: '‡¶¨‡¶ø‡¶®‡ßã‡¶¶‡¶®', color: '#3F51B5' },
            { name: '‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ', color: '#00BCD4' },
            { name: '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø', color: '#9E9E9E' }
        ]
    };

    let categories = JSON.parse(localStorage.getItem('categories_v2')) || defaultCategories;

    function verifyPin() {
        const pin = document.getElementById('pin-input').value;
        if(pin === userPin) {
            document.getElementById('pin-screen').style.display = 'none';
            init();
        } else {
            alert("‡¶≠‡ßÅ‡¶≤ PIN!");
            document.getElementById('pin-input').value = '';
        }
    }

    function init() {
        const saved = localStorage.getItem('smart_hisab_v34');
        if(saved) history = JSON.parse(saved);

        populateFilters();
        populateCategorySelects();
        renderCategoryLists();
        setTodayDate();
        render();
    }

    function setTodayDate() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('income-date').value = today;
        document.getElementById('expense-date').value = today;
    }

    function populateFilters() {
        const months = ['‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø','‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø','‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö','‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤','‡¶Æ‡ßá','‡¶ú‡ßÅ‡¶®','‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á','‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü','‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞','‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞','‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞','‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞'];
        const monthSelect = document.getElementById('filter-month');
        const yearSelect = document.getElementById('filter-year');
        const yearOnlySelect = document.getElementById('filter-year-only');
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        monthSelect.innerHTML = '';
        months.forEach((m, i) => {
            monthSelect.innerHTML += `<option value="${i}" ${i===currentMonth?'selected':''}>${m}</option>`;
        });

        yearSelect.innerHTML = '';
        yearOnlySelect.innerHTML = '';
        for(let y = currentYear; y >= currentYear - 10; y--) {
            yearSelect.innerHTML += `<option value="${y}" ${y===currentYear?'selected':''}>${y}</option>`;
            yearOnlySelect.innerHTML += `<option value="${y}" ${y===currentYear?'selected':''}>${y}</option>`;
        }

        monthSelect.onchange = render;
        yearSelect.onchange = render;
        yearOnlySelect.onchange = render;
        document.getElementById('filter-start-date').onchange = render;
        document.getElementById('filter-end-date').onchange = render;
    }

    function setView(event, view) {
        currentView = view;
        document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        document.getElementById('monthly-filter').style.display = view === 'monthly' ? 'flex' : 'none';
        document.getElementById('yearly-filter').style.display = view === 'yearly' ? 'flex' : 'none';
        document.getElementById('custom-filter').style.display = view === 'custom' ? 'block' : 'none';

        render();
    }

    function populateCategorySelects() {
        const incomeSelect = document.getElementById('income-category');
        const expenseSelect = document.getElementById('expense-category');

        incomeSelect.innerHTML = '<option value="">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>';
        categories.income.forEach(cat => {
            incomeSelect.innerHTML += `<option value="${escapeHtml(cat.name)}">${escapeHtml(cat.name)}</option>`;
        });

        expenseSelect.innerHTML = '<option value="">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>';
        categories.expense.forEach(cat => {
            expenseSelect.innerHTML += `<option value="${escapeHtml(cat.name)}">${escapeHtml(cat.name)}</option>`;
        });
    }

    function openEntryPanel() {
        document.getElementById('entryPanel').classList.add('active');
    }

    function closeEntryPanel() {
        document.getElementById('entryPanel').classList.remove('active');
        clearEntryForms();
    }

    function clearEntryForms() {
        document.getElementById('income-amount').value = '';
        document.getElementById('income-title').value = '';
        document.getElementById('income-category').value = '';
        document.getElementById('expense-amount').value = '';
        document.getElementById('expense-title').value = '';
        document.getElementById('expense-category').value = '';
        setTodayDate();
    }

    function switchEntryTab(event, type) {
        currentEntryType = type;
        
        document.querySelectorAll('.entry-tab').forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');

        document.getElementById('income-form').classList.remove('active');
        document.getElementById('expense-form').classList.remove('active');

        if(type === 'income') {
            document.getElementById('income-form').classList.add('active');
        } else {
            document.getElementById('expense-form').classList.add('active');
        }
    }

    function submitEntry(type) {
        const amount = parseFloat(document.getElementById(`${type}-amount`).value);
        const title = document.getElementById(`${type}-title`).value.trim();
        const category = document.getElementById(`${type}-category`).value;
        const dateStr = document.getElementById(`${type}-date`).value;

        if(!amount || amount <= 0) {
            alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®");
            return;
        }

        if(!title) {
            alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶¶‡¶ø‡¶®");
            return;
        }

        if(!category) {
            alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®");
            return;
        }

        if(!dateStr) {
            alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®");
            return;
        }

        history.unshift({
            id: Date.now().toString(),
            date: dateStr,
            type: type,
            amount,
            title,
            category: category
        });

        localStorage.setItem('smart_hisab_v34', JSON.stringify(history));
        render();
        closeEntryPanel();
        alert(`${type === 'income' ? '‡¶Ü‡¶Ø‡¶º' : '‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º'} ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`);
    }

    function openCategoryPanel() {
        document.getElementById('categoryPanel').classList.add('active');
        renderCategoryLists();
    }

    function closeCategoryPanel() {
        document.getElementById('categoryPanel').classList.remove('active');
    }

    function switchCatTab(event, type) {
        currentCatType = type;
        
        document.querySelectorAll('.cat-tab').forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');

        document.getElementById('catListIncome').style.display = type === 'income' ? 'block' : 'none';
        document.getElementById('catListExpense').style.display = type === 'expense' ? 'block' : 'none';
    }

    function renderCategoryLists() {
        const incomeList = document.getElementById('catListIncome');
        const expenseList = document.getElementById('catListExpense');

        incomeList.innerHTML = '';
        categories.income.forEach((cat, index) => {
            incomeList.innerHTML += `
                <div class="cat-item">
                    <div class="cat-item-info">
                        <span class="cat-color-dot" style="background-color: ${cat.color}"></span>
                        <span>${escapeHtml(cat.name)}</span>
                    </div>
                    <div class="cat-actions">
                        <button class="cat-edit-btn" onclick="editCategory('income', ${index})">‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</button>
                        <button class="cat-delete-btn" onclick="deleteCategory('income', ${index})">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
                    </div>
                </div>
            `;
        });

        expenseList.innerHTML = '';
        categories.expense.forEach((cat, index) => {
            expenseList.innerHTML += `
                <div class="cat-item">
                    <div class="cat-item-info">
                        <span class="cat-color-dot" style="background-color: ${cat.color}"></span>
                        <span>${escapeHtml(cat.name)}</span>
                    </div>
                    <div class="cat-actions">
                        <button class="cat-edit-btn" onclick="editCategory('expense', ${index})">‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ</button>
                        <button class="cat-delete-btn" onclick="deleteCategory('expense', ${index})">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
                    </div>
                </div>
            `;
        });
    }

    function addCategory() {
        const name = document.getElementById('newCatName').value.trim();
        const color = document.getElementById('newCatColor').value;

        if(!name) {
            alert('‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®');
            return;
        }

        const exists = categories[currentCatType].some(c => c.name.toLowerCase() === name.toLowerCase());
        if(exists) {
            alert('‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ü‡¶ó‡ßá ‡¶•‡ßá‡¶ï‡ßá‡¶á ‡¶Ü‡¶õ‡ßá');
            return;
        }

        categories[currentCatType].push({ name, color });
        saveCategories();
        populateCategorySelects();
        renderCategoryLists();
        
        document.getElementById('newCatName').value = '';
        document.getElementById('newCatColor').value = '#e91e63';
        
        alert('‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
    }

    function editCategory(type, index) {
        const cat = categories[type][index];
        const newName = prompt('‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡¶æ‡¶Æ:', cat.name);
        
        if(newName && newName.trim()) {
            categories[type][index].name = newName.trim();
            saveCategories();
            populateCategorySelects();
            renderCategoryLists();
            render();
        }
    }

    function deleteCategory(type, index) {
        if(confirm('‡¶è‡¶á ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?')) {
            categories[type].splice(index, 1);
            saveCategories();
            populateCategorySelects();
            renderCategoryLists();
            render();
        }
    }

    function saveCategories() {
        localStorage.setItem('categories_v2', JSON.stringify(categories));
    }

    function getCategoryColor(categoryName) {
        for(let cat of categories.income) {
            if(cat.name === categoryName) return cat.color;
        }
        for(let cat of categories.expense) {
            if(cat.name === categoryName) return cat.color;
        }
        return '#999';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateStr) {
        const months = ['‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø','‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø','‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö','‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤','‡¶Æ‡ßá','‡¶ú‡ßÅ‡¶®','‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á','‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü','‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞','‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞','‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞','‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞'];
        const d = new Date(dateStr + 'T00:00:00');
        return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }

    function updateCardTitles() {
        const viewTitles = {
            'today': { income: '‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶Ü‡¶Ø‡¶º', expense: '‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º', balance: '‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏' },
            'monthly': { income: '‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶Ü‡¶Ø‡¶º', expense: '‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º', balance: '‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏' },
            'yearly': { income: '‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶Ü‡¶Ø‡¶º', expense: '‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º', balance: '‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏' },
            'custom': { income: '‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶Ü‡¶Ø‡¶º', expense: '‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º', balance: '‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏' }
        };

        const titles = viewTitles[currentView];
        document.getElementById('card-income-title').textContent = titles.income;
        document.getElementById('card-expense-title').textContent = titles.expense;
        document.getElementById('card-balance-title').textContent = titles.balance;
    }

    function updateChartAndList(listData) {
        const categoryStats = {};

        listData.forEach(item => {
            const cat = item.category || '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£';
            if (!categoryStats[cat]) {
                categoryStats[cat] = { income: 0, expense: 0, total: 0 };
            }
            if (item.type === 'income') {
                categoryStats[cat].income += item.amount;
                categoryStats[cat].total += item.amount;
            } else {
                categoryStats[cat].expense += item.amount;
                categoryStats[cat].total -= item.amount;
            }
        });

        const totalIncome = listData.filter(i => i.type === 'income').reduce((sum, i) => sum + i.amount, 0);
        const totalExpense = listData.filter(i => i.type === 'expense').reduce((sum, i) => sum + i.amount, 0);
        const balance = totalIncome - totalExpense;

        document.getElementById('total-income').textContent = '‡ß≥' + totalIncome.toLocaleString('bn-BD');
        document.getElementById('total-expense').textContent = '‡ß≥' + totalExpense.toLocaleString('bn-BD');
        document.getElementById('balance').textContent = '‡ß≥' + balance.toLocaleString('bn-BD');

        const labels = Object.keys(categoryStats);
        const chartData = labels.map(cat => Math.abs(categoryStats[cat].total));
        const colors = labels.map(cat => getCategoryColor(cat));

        const chartCanvas = document.getElementById('categoryChart');
        const ctx = chartCanvas.getContext('2d');

        if (categoryChart) {
            categoryChart.destroy();
        }

        if (labels.length === 0) {
            ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
            ctx.font = '14px Arial';
            ctx.fillStyle = '#999';
            ctx.textAlign = 'center';
            ctx.fillText('‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á', chartCanvas.width / 2, chartCanvas.height / 2);
            document.getElementById('categoryList').innerHTML = '<p style="text-align:center; color:#999; padding:20px;">‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á</p>';
            return;
        }

        categoryChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: chartData,
                    backgroundColor: colors,
                    borderWidth: 3,
                    borderColor: 'white'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const cat = context.label;
                                const stats = categoryStats[cat];
                                return [
                                    `${cat}: ‡ß≥${stats.total.toLocaleString('bn-BD')}`,
                                    `  ‡¶Ü‡¶Ø‡¶º: +‡ß≥${stats.income.toLocaleString('bn-BD')}`,
                                    `  ‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º: -‡ß≥${stats.expense.toLocaleString('bn-BD')}`
                                ];
                            }
                        }
                    }
                }
            }
        });

        const categoryList = document.getElementById('categoryList');
        categoryList.innerHTML = '';
        const sortedCategories = labels.sort((a, b) => categoryStats[b].total - categoryStats[a].total);

        sortedCategories.forEach(cat => {
            const stats = categoryStats[cat];
            const color = getCategoryColor(cat);
            const itemDiv = document.createElement('div');
            itemDiv.className = 'category-item';
            itemDiv.innerHTML = `
                <div class="category-name">
                    <span class="color-dot" style="background-color: ${color};"></span>
                    <span>${escapeHtml(cat)}</span>
                </div>
                <div class="category-amount">‡ß≥${stats.total.toLocaleString('bn-BD')}</div>
            `;
            categoryList.appendChild(itemDiv);
        });
    }

    function render() {
        const list = document.getElementById('list');
        const now = new Date();
        const todayStr = now.toISOString().split('T')[0];
        const selM = parseInt(document.getElementById('filter-month').value);
        const selY = parseInt(document.getElementById('filter-year').value);

        let listData = [];

        if (currentView === 'custom') {
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;

            if (!startDate || !endDate) {
                list.innerHTML = '<p class="empty-state">‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ì ‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</p>';
                updateChartAndList([]);
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                list.innerHTML = '<p class="date-filter-error">‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶∂‡ßá‡¶∑‡ßá‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá</p>';
                updateChartAndList([]);
                return;
            }

            listData = history.filter(item => item.date >= startDate && item.date <= endDate);
        }
        else if (currentView === 'today') {
            listData = history.filter(item => item.date === todayStr);
        }
        else if (currentView === 'monthly') {
            listData = history.filter(item => {
                const d = new Date(item.date + 'T00:00:00');
                return d.getMonth() === selM && d.getFullYear() === selY;
            });
        }
        else if (currentView === 'yearly') {
            listData = history.filter(item => {
                const d = new Date(item.date + 'T00:00:00');
                return d.getFullYear() === selY;
            });
        }

        list.innerHTML = '';
        listData.reverse().forEach(item => {
            const typeText = item.type === 'income' ? '‡¶Ü‡¶Ø‡¶º' : '‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º';
            const formattedDate = formatDate(item.date);
            const category = item.category || '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£';

            list.innerHTML += `<div class="item" style="border-left-color: ${item.type==='income'?'var(--income-green)':'var(--expense-red)'}">
                <div style="flex: 1;">
                    <b>${escapeHtml(item.title)}</b><span class="cat-badge">${escapeHtml(category)}</span>
                    <br><small style="color:#888">${formattedDate}</small>
                </div>
                <div style="text-align:right; white-space: nowrap;">
                    <div style="color:${item.type==='income'?'var(--income-green)':'var(--expense-red)'}; font-weight:bold">${typeText} ‡ß≥${item.amount.toLocaleString('bn-BD')}</div>
                    <button class="delete-btn" onclick="deleteWithPin('${item.id}')">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
                </div>
            </div>`;
        });

        if(listData.length === 0 && currentView !== 'custom') {
            list.innerHTML = '<p class="empty-state">‡¶ï‡ßã‡¶®‡ßã ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡ßá‡¶á</p>';
        }

        updateChartAndList(listData);
        updateCardTitles();
        localStorage.setItem('smart_hisab_v34', JSON.stringify(history));
    }

    function deleteWithPin(id) {
        const enteredPin = prompt("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá PIN ‡¶¶‡¶ø‡¶®:");

        if (enteredPin === null) return;

        if (enteredPin === userPin) {
            if(confirm("‡¶è‡¶á ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")) {
                history = history.filter(i => i.id !== id);
                render();
                alert("‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá");
            }
        } else {
            alert("‡¶≠‡ßÅ‡¶≤ PIN!");
        }
    }

    function toggleMenu() {
        const menu = document.getElementById('sideMenu');
        const overlay = document.getElementById('overlay');
        menu.classList.toggle('active');
        overlay.classList.toggle('active');
    }

    function createBackup() {
        if(history.length === 0) {
            alert("‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø");
            return;
        }
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(history, null, 2));
        const dl = document.createElement('a');
        dl.setAttribute("href", dataStr);
        dl.setAttribute("download", "smart_hisab_backup_" + new Date().toISOString().split('T')[0] + ".json");
        dl.click();
    }

    function restoreBackup(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (!Array.isArray(data)) {
                    throw new Error('‡¶°‡ßá‡¶ü‡¶æ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶≠‡ßÅ‡¶≤');
                }
                history = data;
                localStorage.setItem('smart_hisab_v34', JSON.stringify(history));
                render();
                alert("‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶∏‡¶´‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
            } catch(err) {
                alert("‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: " + err.message);
            }
        };
        reader.readAsText(file);
    }

    function exportToExcel() {
        if(history.length === 0) {
            alert("‡¶ï‡ßã‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø");
            return;
        }
        
        const exportData = history.map(item => ({
            '‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ': item.date,
            '‡¶¨‡¶ø‡¶¨‡¶∞‡¶£': item.title,
            '‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø': item.category || '‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£',
            '‡¶Ü‡¶Ø‡¶º': item.type === 'income' ? item.amount : '',
            '‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º': item.type === 'expense' ? item.amount : ''
        }));
        
        const ws = XLSX.utils.json_to_sheet(exportData);
        
        // ‡¶ï‡¶≤‡¶æ‡¶Æ ‡¶â‡¶á‡¶°‡ßç‡¶• ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
        ws['!cols'] = [
            { wch: 12 },  // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ
            { wch: 20 },  // ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£
            { wch: 15 },  // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø
            { wch: 12 },  // ‡¶Ü‡¶Ø‡¶º
            { wch: 12 }   // ‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º
        ];
        
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "‡¶Ü‡¶Ø‡¶º ‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º");
        XLSX.writeFile(wb, "smart_hisab_" + new Date().toISOString().split('T')[0] + ".xlsx");
    }

    function setNewPin() {
        const oldPin = prompt("‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® PIN:");
        if(oldPin === null) return;

        if(oldPin === userPin) {
            const newPin = prompt("‡¶®‡¶§‡ßÅ‡¶® ‡ß™ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶∞ PIN ‡¶¶‡¶ø‡¶®:");
            if(newPin === null) return;

            if(newPin && newPin.length === 4 && /^\d+$/.test(newPin)) {
                localStorage.setItem('app_pin', newPin);
                userPin = newPin;
                alert("PIN ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
            } else {
                alert("PIN ‡¶†‡¶ø‡¶ï ‡ß™‡¶ü‡¶ø ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá!");
            }
        } else {
            alert("‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® PIN ‡¶≠‡ßÅ‡¶≤!");
        }
    }
</script>
</body>
</html>
